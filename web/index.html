<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤æ¸¬è©¦ä»‹é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 20px;
            background: #007bff;
            color: white;
            text-align: center;
        }

        .user-info h3 {
            margin-bottom: 10px;
        }

        .user-select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .user-select option {
            color: #333;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .contacts-section, .rooms-section {
            margin-bottom: 15px;
        }

        .contacts-section h4, .rooms-section h4 {
            margin: 0 0 10px 0;
            padding: 0 10px;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contacts-list {
            margin-bottom: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            margin: 2px 10px;
        }

        .contact-item:hover {
            background: #e3f2fd;
            transform: translateX(2px);
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            margin-right: 12px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .contact-status {
            font-size: 12px;
            color: #666;
        }

        .contact-status:before {
            content: "â—";
            color: #4caf50;
            margin-right: 4px;
        }

        .contact-item:hover .contact-status:before {
            color: #2e7d32;
        }

        .room-list {
            padding: 0 10px;
        }

        .room-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .room-item:hover {
            background: #f5f5f5;
        }

        .room-item.active {
            background: #e3f2fd;
            border-color: #007bff;
        }

        .room-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .room-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-name {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-time {
            font-size: 11px;
            color: #999;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .room-preview {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: #ff3b30;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .room-type {
            font-size: 12px;
            color: #666;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .room-type.direct {
            background: #d4edda;
            color: #155724;
        }

        .room-type.group {
            background: #cce5ff;
            color: #004085;
        }

        .create-room {
            padding: 15px;
            margin-top: 10px;
        }

        .create-room-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .create-room-btn:hover {
            background: #218838;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: bold;
        }

        .chat-type {
            font-size: 12px;
            color: #666;
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 15px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            max-width: 70%;
            position: relative;
        }

        .message.own {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .message.other {
            margin-right: auto;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.own .message-avatar {
            background: #28a745;
        }

        .message.other .message-avatar {
            background: #6c757d;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            margin-bottom: 0;
        }

        .message.own .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.other .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-info {
            font-size: 10px;
            color: #999;
            margin-top: 4px;
        }

        .message.own .message-info {
            text-align: right;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
        }
        
        .message.other .message-info {
            color: #666;
            font-size: 11px;
        }
        
        .read-status {
            white-space: nowrap;
        }

        .message-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .message-input input:focus {
            border-color: #007bff;
        }

        .send-btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }

        .send-btn:hover {
            background: #0056b3;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .status {
            padding: 10px 20px;
            background: #e9ecef;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* ç³»çµ±æ¶ˆæ¯æ¨£å¼ */
        .message.system {
            justify-content: center;
            margin: 15px 0;
        }

        .message.system .message-content {
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            padding: 5px 15px;
            border-radius: 12px;
            text-align: center;
            max-width: 80%;
        }

        /* æˆå“¡å´é‚Šæ¬„ */
        .members-sidebar {
            width: 250px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .members-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .btn-close:hover {
            color: #333;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .member-item:hover {
            background: #f5f5f5;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 18px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .member-role {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar">
            <div class="user-info">
                <h3>èŠå¤©å®¤æ¸¬è©¦</h3>
                <select class="user-select" id="userSelect">
                    <option value="user_alice">Alice</option>
                    <option value="user_bob">Bob</option>
                    <option value="user_charlie">Charlie</option>
                    <option value="user_david">David</option>
                </select>
            </div>
            
            <div class="sidebar-content">
                <!-- è¯çµ¡äººåˆ—è¡¨ -->
                <div class="contacts-section">
                    <h4>è¯çµ¡äºº</h4>
                    <div class="contacts-list" id="contactsList">
                        <div class="contact-item" onclick="startChatWith('user_alice')">
                            <div class="contact-avatar">A</div>
                            <div class="contact-info">
                                <div class="contact-name">Alice</div>
                                <div class="contact-status">åœ¨ç·š</div>
                            </div>
                        </div>
                        <div class="contact-item" onclick="startChatWith('user_bob')">
                            <div class="contact-avatar">B</div>
                            <div class="contact-info">
                                <div class="contact-name">Bob</div>
                                <div class="contact-status">åœ¨ç·š</div>
                            </div>
                        </div>
                        <div class="contact-item" onclick="startChatWith('user_charlie')">
                            <div class="contact-avatar">C</div>
                            <div class="contact-info">
                                <div class="contact-name">Charlie</div>
                                <div class="contact-status">é›¢ç·š</div>
                            </div>
                        </div>
                        <div class="contact-item" onclick="startChatWith('user_david')">
                            <div class="contact-avatar">D</div>
                            <div class="contact-info">
                                <div class="contact-name">David</div>
                                <div class="contact-status">åœ¨ç·š</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- èŠå¤©å®¤åˆ—è¡¨ -->
                <div class="rooms-section">
                    <h4>èŠå¤©å®¤</h4>
                    <div class="room-list" id="roomList">
                        <div class="loading">è¼‰å…¥èŠå¤©å®¤ä¸­...</div>
                    </div>
                </div>
                
                <div class="create-room">
                    <button class="create-room-btn" onclick="showCreateRoomModal()">
                        + å‰µå»ºç¾¤çµ„
                    </button>
                </div>
            </div>
        </div>

        <!-- èŠå¤©å€åŸŸ -->
        <div class="chat-area">
            <div class="chat-header">
                <div>
                    <div class="chat-title" id="chatTitle">é¸æ“‡èŠå¤©å®¤</div>
                    <div class="chat-type" id="chatType"></div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="showMembersBtn" style="display: none;" onclick="toggleMemberList()">ğŸ‘¥ æˆå“¡</button>
                    <button class="btn btn-secondary" id="roomSettingsBtn" style="display: none;" onclick="showRoomSettings()">è¨­ç½®</button>
                </div>
            </div>
            
            <div style="display: flex; flex: 1; overflow: hidden;">
                <div class="messages" id="messages" style="flex: 1;">
                    <div style="text-align: center; color: #999; padding: 80px 50px; display: flex; flex-direction: column; align-items: center; gap: 20px;">
                        <div style="font-size: 64px;">ğŸ’¬</div>
                        <div style="font-size: 18px; color: #666;">é¸æ“‡èŠå¤©å®¤é–‹å§‹å°è©±</div>
                        <div style="font-size: 14px; color: #999;">å¾å·¦å´èŠå¤©å®¤åˆ—è¡¨é¸æ“‡ï¼Œæˆ–é»æ“Šè¯çµ¡äººé–‹å§‹æ–°å°è©±</div>
                    </div>
                </div>
                
                <!-- æˆå“¡åˆ—è¡¨å´é‚Šæ¬„ -->
                <div class="members-sidebar" id="membersSidebar" style="display: none;">
                    <div class="members-header">
                        <h4>ç¾¤çµ„æˆå“¡</h4>
                        <button class="btn-close" onclick="toggleMemberList()">âœ•</button>
                    </div>
                    <div class="members-list" id="membersSidebarList">
                        <!-- æˆå“¡åˆ—è¡¨å°‡å‹•æ…‹å¡«å…… -->
                    </div>
                </div>
            </div>
            
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="è¼¸å…¥æ¶ˆæ¯..." disabled>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>ç™¼é€</button>
            </div>
        </div>
    </div>

    <!-- ç¾¤çµ„è¨­ç½®æ¨¡æ…‹æ¡† -->
    <div class="modal" id="roomSettingsModal">
        <div class="modal-content">
            <h3>ç¾¤çµ„è¨­ç½®</h3>
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">ç¾¤çµ„æˆå“¡</h4>
                <div id="roomMembersList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                    <!-- æˆå“¡åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <h4 style="margin-bottom: 10px;">æ·»åŠ æˆå“¡</h4>
                <div style="display: flex; gap: 10px;">
                    <select id="addMemberSelect" style="flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">é¸æ“‡è¦æ·»åŠ çš„æˆå“¡</option>
                    </select>
                    <button class="btn btn-primary" onclick="addMember()">æ·»åŠ </button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-danger" onclick="leaveRoom()">é€€å‡ºç¾¤çµ„</button>
                <button type="button" class="btn btn-secondary" onclick="hideRoomSettings()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- å‰µå»ºèŠå¤©å®¤æ¨¡æ…‹æ¡† -->
    <div class="modal" id="createRoomModal">
        <div class="modal-content">
            <h3>å‰µå»ºç¾¤çµ„</h3>
            <form id="createRoomForm">
                <div class="form-group">
                    <label for="roomName">ç¾¤çµ„åç¨±</label>
                    <input type="text" id="roomName" required>
                </div>
                
                <div class="form-group" id="membersGroup">
                    <label for="roomMembers">é¸æ“‡æˆå“¡ (è‡³å°‘1äºº)</label>
                    <select id="roomMembers" multiple size="4">
                        <option value="user_alice">Alice</option>
                        <option value="user_bob">Bob</option>
                        <option value="user_charlie">Charlie</option>
                        <option value="user_david">David</option>
                    </select>
                    <small style="color: #666; margin-top: 5px; display: block;">æŒ‰ä½ Ctrl (Windows) æˆ– Cmd (Mac) å¯é¸æ“‡å¤šå€‹</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateRoomModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å‰µå»ºç¾¤çµ„</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let currentUser = 'user_alice';
        let currentRoom = null;
        let rooms = [];
        let websocket = null;
        let messageHistory = {};
        let contacts = [
            { id: 'user_alice', name: 'Alice', status: 'online' },
            { id: 'user_bob', name: 'Bob', status: 'online' },
            { id: 'user_charlie', name: 'Charlie', status: 'offline' },
            { id: 'user_david', name: 'David', status: 'online' }
        ];

        // API åŸºç¤ URL
        const API_BASE = 'http://localhost:8080/api/v1';
        const WS_BASE = 'ws://localhost:8080/ws';

        // é˜²æ­¢é‡è¤‡åˆå§‹åŒ–
        let isInitialized = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (!isInitialized) {
                initializeApp();
                isInitialized = true;
            }
        });

        // åˆå§‹åŒ–æ‡‰ç”¨
        function initializeApp() {
            
            // è¨­ç½®ç”¨æˆ¶é¸æ“‡äº‹ä»¶
            document.getElementById('userSelect').addEventListener('change', function() {
                currentUser = this.value;
                console.log('åˆ‡æ›ç”¨æˆ¶:', currentUser);
                
                // æ¸…ç©ºç•¶å‰ç‹€æ…‹
                currentRoom = null;
                rooms = [];
                messageHistory = {};
                
                // é‡ç½® UI
                document.getElementById('chatTitle').textContent = 'é¸æ“‡èŠå¤©å®¤';
                document.getElementById('chatType').textContent = '';
                document.getElementById('messages').innerHTML = '<div style="text-align: center; color: #999; padding: 80px 50px; display: flex; flex-direction: column; align-items: center; gap: 20px;"><div style="font-size: 64px;">ğŸ’¬</div><div style="font-size: 18px; color: #666;">é¸æ“‡èŠå¤©å®¤é–‹å§‹å°è©±</div><div style="font-size: 14px; color: #999;">å¾å·¦å´èŠå¤©å®¤åˆ—è¡¨é¸æ“‡ï¼Œæˆ–é»æ“Šè¯çµ¡äººé–‹å§‹æ–°å°è©±</div></div>';
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('roomSettingsBtn').style.display = 'none';
                
                // é‡æ–°è¼‰å…¥æ•¸æ“š
                loadRooms();
                renderContacts();
            });

            // è¨­ç½®è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('createRoomForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createRoom();
            });

            // è¨­ç½®æ¶ˆæ¯è¼¸å…¥äº‹ä»¶
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });


            // è¼‰å…¥èŠå¤©å®¤
            loadRooms();
            
            // æ¸²æŸ“è¯çµ¡äººåˆ—è¡¨
            renderContacts();
            
            // è¨­ç½®èŠå¤©å®¤åˆ—è¡¨æ»¾å‹•ç›£è½
            setupRoomListScroll();
            
            // è¨­ç½®è¨Šæ¯å®¹å™¨æ»¾å‹•ç›£è½
            setupMessagesScroll();
            
            // å®šæœŸåˆ·æ–°èŠå¤©å®¤åˆ—è¡¨ï¼ˆæ¯30ç§’ï¼‰ï¼Œä»¥ä¾¿æ¥æ”¶æ–°çš„èŠå¤©å®¤é‚€è«‹
            setInterval(() => {
                loadRooms();
            }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // å°‡ user_id è½‰æ›ç‚ºé¡¯ç¤ºåç¨±
        function getDisplayName(userId) {
            const user = contacts.find(c => c.id === userId);
            return user ? user.name : userId.replace('user_', '');
        }

        // ç²å–èŠå¤©å®¤é¡¯ç¤ºåç¨±
        function getRoomDisplayName(room) {
            if (room.type === 'group') {
                return room.name; // ç¾¤çµ„ç›´æ¥é¡¯ç¤ºç¾¤çµ„åç¨±
            } else if (room.type === 'direct' && room.members) {
                // ç§èŠï¼šæ‰¾åˆ°é™¤äº†ç•¶å‰ç”¨æˆ¶å¤–çš„å…¶ä»–æˆå“¡
                const otherMember = room.members.find(member => member.user_id !== currentUser);
                if (otherMember) {
                    return getDisplayName(otherMember.user_id);
                }
            }
            return room.name; // å‚™ç”¨ï¼šç›´æ¥é¡¯ç¤ºæˆ¿é–“åç¨±
        }

        // æ ¼å¼åŒ–è¨Šæ¯æ™‚é–“ï¼ˆç”¨æ–¼èŠå¤©å®¤åˆ—è¡¨ï¼‰
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp * 1000); // Unix timestamp è½‰æ›
            const now = new Date();
            const diff = now - date;
            
            // ä»Šå¤©ï¼šåªé¡¯ç¤ºæ™‚é–“
            if (diff < 24 * 60 * 60 * 1000 && now.getDate() === date.getDate()) {
                return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            }
            
            // æ˜¨å¤©
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth()) {
                return 'æ˜¨å¤©';
            }
            
            // ä¸€é€±å…§ï¼šé¡¯ç¤ºæ˜ŸæœŸ
            if (diff < 7 * 24 * 60 * 60 * 1000) {
                const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                return days[date.getDay()];
            }
            
            // è¶…éä¸€é€±ï¼šé¡¯ç¤ºæ—¥æœŸ
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // è¼‰å…¥èŠå¤©å®¤åˆ—è¡¨
        let isLoadingRooms = false;
        let hasMoreRooms = true;
        let roomsCursor = '';
        
        async function loadRooms(loadMore = false) {
            if (isLoadingRooms) {
                return;
            }
            
            // å¦‚æœæ˜¯é¦–æ¬¡åŠ è¼‰ï¼Œé‡ç½®ç‹€æ…‹
            if (!loadMore) {
                rooms = [];
                roomsCursor = '';
                hasMoreRooms = true;
            }
            
            // å¦‚æœæ²’æœ‰æ›´å¤šæ•¸æ“šï¼Œä¸è¦ç¹¼çºŒåŠ è¼‰
            if (loadMore && !hasMoreRooms) {
                return;
            }
            
            isLoadingRooms = true;
            try {
                const url = `${API_BASE}/rooms?user_id=${currentUser}&limit=10&cursor=${roomsCursor}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const newRooms = data.data || [];
                    
                    if (loadMore) {
                        // è¿½åŠ åˆ°ç¾æœ‰åˆ—è¡¨
                        rooms = [...rooms, ...newRooms];
                    } else {
                        // æ›¿æ›æ•´å€‹åˆ—è¡¨
                        rooms = newRooms;
                    }
                    
                    // æ›´æ–° cursor å’Œç‹€æ…‹
                    roomsCursor = data.cursor || '';
                    hasMoreRooms = data.has_more || false;
                    
                    renderRoomList();
                } else {
                    showError('è¼‰å…¥èŠå¤©å®¤å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('è¼‰å…¥èŠå¤©å®¤å¤±æ•—: ' + error.message);
            } finally {
                isLoadingRooms = false;
            }
        }

        // æ¸²æŸ“è¯çµ¡äººåˆ—è¡¨
        function renderContacts() {
            const contactsList = document.getElementById('contactsList');
            
            // éæ¿¾æ‰ç•¶å‰ç”¨æˆ¶
            const otherContacts = contacts.filter(contact => contact.id !== currentUser);
            
            contactsList.innerHTML = otherContacts.map(contact => `
                <div class="contact-item" data-contact-id="${contact.id}">
                    <div class="contact-avatar">${contact.name.charAt(0)}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status">${contact.status === 'online' ? 'åœ¨ç·š' : 'é›¢ç·š'}</div>
                    </div>
                </div>
            `).join('');
            
            // ä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œé¿å…å…§è¯ onclick
            contactsList.querySelectorAll('.contact-item').forEach(item => {
                item.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    startChatWith(this.dataset.contactId);
                };
            });
        }

        // æ¸²æŸ“èŠå¤©å®¤åˆ—è¡¨
        function renderRoomList() {
            const roomList = document.getElementById('roomList');
            
            if (rooms.length === 0) {
                roomList.innerHTML = '<div class="loading">æ²’æœ‰èŠå¤©å®¤</div>';
                return;
            }
            
            // æŒ‰æœ€å¾Œè¨Šæ¯æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            const sortedRooms = [...rooms].sort((a, b) => {
                const timeA = a.last_message_time ? new Date(a.last_message_time) : new Date(a.created_at || 0);
                const timeB = b.last_message_time ? new Date(b.last_message_time) : new Date(b.created_at || 0);
                return timeB - timeA;
            });
            
            roomList.innerHTML = sortedRooms.map(room => {
                const displayName = getRoomDisplayName(room);
                const lastMessage = room.last_message || 'é–‹å§‹æ–°å°è©±...';
                const lastTime = room.last_message_time ? formatMessageTime(room.last_message_time) : '';
                const unreadCount = room.unread_count || 0;
                
                return `
                    <div class="room-item ${currentRoom && currentRoom.id === room.id ? 'active' : ''}" data-room-id="${room.id}">
                        <div class="room-avatar">${displayName.charAt(0)}</div>
                        <div class="room-info">
                            <div class="room-header">
                                <div class="room-name">${displayName}</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                                    <div class="room-time">${lastTime}</div>
                                </div>
                            </div>
                            <div class="room-preview">${lastMessage}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼Œé¿å…å…§è¯ onclick
            roomList.querySelectorAll('.room-item').forEach(item => {
                item.onclick = function() {
                    selectRoom(this.dataset.roomId);
                };
            });
            
            // æ·»åŠ  "åŠ è¼‰æ›´å¤š" æç¤ºï¼ˆå¦‚æœé‚„æœ‰æ›´å¤šï¼‰
            if (hasMoreRooms) {
                const loadMoreDiv = document.createElement('div');
                loadMoreDiv.className = 'load-more-indicator';
                loadMoreDiv.id = 'roomsLoadMore';
                loadMoreDiv.textContent = isLoadingRooms ? 'è¼‰å…¥ä¸­...' : 'å¾€ä¸‹æ»¾å‹•è¼‰å…¥æ›´å¤š';
                loadMoreDiv.style.cssText = 'text-align: center; padding: 15px; color: #999; font-size: 12px;';
                roomList.appendChild(loadMoreDiv);
            }
        }
        
        // ç›£è½èŠå¤©å®¤åˆ—è¡¨æ»¾å‹•ï¼ˆå¾€ä¸‹æ»¾å‹•åŠ è¼‰æ›´å¤šï¼‰
        function setupRoomListScroll() {
            const sidebarContent = document.querySelector('.sidebar-content');
            if (!sidebarContent) return;
            
            sidebarContent.addEventListener('scroll', function() {
                // æª¢æ¸¬æ˜¯å¦æ»¾å‹•åˆ°åº•éƒ¨
                const scrollTop = this.scrollTop;
                const scrollHeight = this.scrollHeight;
                const clientHeight = this.clientHeight;
                
                // è·é›¢åº•éƒ¨ 100px æ™‚é–‹å§‹åŠ è¼‰
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    if (hasMoreRooms && !isLoadingRooms) {
                        loadRooms(true); // loadMore = true
                    }
                }
            });
        }
        
        // ç›£è½è¨Šæ¯å®¹å™¨æ»¾å‹•ï¼ˆå¾€ä¸Šæ»¾å‹•åŠ è¼‰æ›´å¤šæ­·å²è¨Šæ¯ï¼‰
        function setupMessagesScroll() {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            messagesContainer.addEventListener('scroll', function() {
                // æª¢æ¸¬æ˜¯å¦æ»¾å‹•åˆ°é ‚éƒ¨
                const scrollTop = this.scrollTop;
                
                // è·é›¢é ‚éƒ¨ 50px æ™‚é–‹å§‹åŠ è¼‰
                if (scrollTop <= 50 && currentRoom && currentRoom.id) {
                    if (hasMoreMessages[currentRoom.id] && !isLoadingMessages) {
                        loadMessages(currentRoom.id, true); // loadMore = true
                    }
                }
            });
        }

        // é–‹å§‹èˆ‡è¯çµ¡äººèŠå¤©
        async function startChatWith(contactId) {
            console.log('é–‹å§‹èŠå¤©:', contactId);
            
            // ä¸èƒ½å’Œè‡ªå·±èŠå¤©
            if (contactId === currentUser) {
                showError('ä¸èƒ½å’Œè‡ªå·±èŠå¤©');
                return;
            }

            // å¦‚æœä¹‹å‰æ˜¯è‡¨æ™‚èŠå¤©å®¤ä¸”æœªç™¼é€è¨Šæ¯ï¼Œæ¸…é™¤å®ƒ
            if (currentRoom && currentRoom.isTemporary) {
                currentRoom = null;
            }

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰èˆ‡æ­¤è¯çµ¡äººçš„èŠå¤©å®¤
            const existingRoom = rooms.find(room => 
                room.type === 'direct' && 
                room.members && 
                room.members.some(member => member.user_id === contactId) &&
                room.members.some(member => member.user_id === currentUser)
            );

            if (existingRoom) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç›´æ¥é€²å…¥èŠå¤©å®¤
                selectRoom(existingRoom.id);
                return;
            }

            // æ‰“é–‹è‡¨æ™‚èŠå¤©çª—å£ï¼ˆä¸å‰µå»ºèŠå¤©å®¤ï¼‰
            const contact = contacts.find(c => c.id === contactId);
            openTemporaryChatWindow(contactId, contact.name);
        }

        // æ‰“é–‹è‡¨æ™‚èŠå¤©çª—å£ï¼ˆç™¼é€ç¬¬ä¸€æ¢è¨Šæ¯æ™‚æ‰å‰µå»ºèŠå¤©å®¤ï¼‰
        function openTemporaryChatWindow(contactId, contactName) {
            // å‰µå»ºè‡¨æ™‚èŠå¤©å®¤å°è±¡ï¼ˆæœªä¿å­˜åˆ°å¾Œç«¯ï¼‰
            currentRoom = {
                id: null, // null è¡¨ç¤ºè‡¨æ™‚èŠå¤©å®¤
                name: `èˆ‡ ${contactName} çš„å°è©±`,
                type: 'direct',
                owner_id: currentUser,
                members: [
                    { user_id: currentUser, role: 'admin' },
                    { user_id: contactId, role: 'member' }
                ],
                isTemporary: true, // æ¨™è¨˜ç‚ºè‡¨æ™‚
                targetContactId: contactId // è¨˜éŒ„ç›®æ¨™è¯çµ¡äºº
            };

            // æ›´æ–° UI
            document.getElementById('chatTitle').textContent = contactName;
            document.getElementById('chatType').textContent = 'ä¸€å°ä¸€èŠå¤©';
            document.getElementById('roomSettingsBtn').style.display = 'none';
            document.getElementById('showMembersBtn').style.display = 'none';
            document.getElementById('messages').innerHTML = '<div style="text-align: center; color: #999; padding: 50px;">é–‹å§‹æ–°å°è©±</div>';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();

            // æ¸…ç©ºè¨Šæ¯æ­·å²
            messageHistory[contactId] = [];
        }

        // é¸æ“‡èŠå¤©å®¤
        function selectRoom(roomId) {
            console.log('é¸æ“‡èŠå¤©å®¤:', roomId);
            
            // å¦‚æœä¹‹å‰æ˜¯è‡¨æ™‚èŠå¤©å®¤ä¸”æœªç™¼é€è¨Šæ¯ï¼Œæ¸…é™¤å®ƒ
            if (currentRoom && currentRoom.isTemporary) {
                currentRoom = null;
            }
            
            const room = rooms.find(r => r.id === roomId);
            if (!room) {
                console.error('æ‰¾ä¸åˆ°èŠå¤©å®¤:', roomId);
                return;
            }

            currentRoom = room;
            
            // æ›´æ–° UI
            const memberCount = room.members ? room.members.length : 0;
            const memberNames = room.members ? room.members.map(m => getDisplayName(m.user_id)).join(', ') : '';
            
            document.getElementById('chatTitle').textContent = getRoomDisplayName(room) + (room.type === 'group' ? ` (${memberCount}äºº)` : '');
            document.getElementById('chatType').textContent = room.type === 'direct' ? 
                'ä¸€å°ä¸€èŠå¤©' : 
                `ç¾¤çµ„èŠå¤© Â· æˆå“¡: ${memberNames}`;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // é¡¯ç¤ºæˆ–éš±è—è¨­ç½®æŒ‰éˆ•å’Œæˆå“¡æŒ‰éˆ•ï¼ˆåªæœ‰ç¾¤çµ„æ‰é¡¯ç¤ºï¼‰
            document.getElementById('roomSettingsBtn').style.display = room.type === 'group' ? 'block' : 'none';
            document.getElementById('showMembersBtn').style.display = room.type === 'group' ? 'block' : 'none';
            
            // ç«‹å³æ›´æ–°é¸ä¸­æ¨£å¼ï¼ˆä½¿ç”¨æ›´é«˜æ•ˆçš„æ–¹å¼ï¼‰
            const previousActive = document.querySelector('.room-item.active');
            if (previousActive) {
                previousActive.classList.remove('active');
            }
            const roomItem = document.querySelector(`[data-room-id="${roomId}"]`);
            if (roomItem) {
                roomItem.classList.add('active');
            }

            // ç«‹å³æ¨™è¨˜ç‚ºå·²è®€ï¼ˆæ¨‚è§€æ›´æ–°ï¼Œä¸ç­‰å¾…ï¼‰
            markRoomAsRead(roomId);

            // å…¶ä»–æ“ä½œå»¶é²åŸ·è¡Œï¼ˆä¸é˜»å¡ UIï¼‰
            requestAnimationFrame(() => {
                // æ›´æ–°æˆå“¡å´é‚Šæ¬„
                renderMembersSidebar();
                
                // è¼‰å…¥æ¶ˆæ¯æ­·å²
                loadMessages(roomId);
                
                // é€£æ¥ WebSocket
                connectWebSocket(roomId);
            });
        }

        // æ¨™è¨˜èŠå¤©å®¤ç‚ºå·²è®€
        async function markRoomAsRead(roomId) {
            // å…ˆç«‹å³æ›´æ–° UIï¼ˆæ¨‚è§€æ›´æ–°ï¼‰ï¼Œä¸ç­‰å¾…ç¶²çµ¡è«‹æ±‚
            const room = rooms.find(r => r.id === roomId);
            if (room) {
                room.unread_count = 0;
            }
            
            // ç›´æ¥ç§»é™¤è©²èŠå¤©å®¤çš„æœªè®€æ¨™è¨˜ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
            const roomItem = document.querySelector(`[data-room-id="${roomId}"]`);
            if (roomItem) {
                const badge = roomItem.querySelector('.unread-badge');
                if (badge) {
                    badge.remove();
                }
            }
            
            // ç„¶å¾Œåœ¨èƒŒæ™¯ç™¼é€è«‹æ±‚åˆ°å¾Œç«¯ï¼ˆä¸é˜»å¡ UIï¼‰
            try {
                fetch(`${API_BASE}/messages/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_id: roomId,
                        user_id: currentUser
                    })
                }).catch(error => {
                    console.log('æ¨™è¨˜å·²è®€å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('æ¨™è¨˜å·²è®€å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥æ¶ˆæ¯æ­·å²
        let isLoadingMessages = false;
        let messagesCursor = {}; // æ¯å€‹æˆ¿é–“çš„ cursorï¼Œæ ¼å¼ï¼š{ roomId: cursor }
        let hasMoreMessages = {}; // æ¯å€‹æˆ¿é–“æ˜¯å¦é‚„æœ‰æ›´å¤šæ¶ˆæ¯
        
        async function loadMessages(roomId, loadMore = false) {
            if (isLoadingMessages) {
                return;
            }
            
            // å¦‚æœæ˜¯é¦–æ¬¡åŠ è¼‰ï¼Œé‡ç½®ç‹€æ…‹
            if (!loadMore) {
                messageHistory[roomId] = [];
                messagesCursor[roomId] = '';
                hasMoreMessages[roomId] = true;
            }
            
            // å¦‚æœæ²’æœ‰æ›´å¤šæ•¸æ“šï¼Œä¸è¦ç¹¼çºŒåŠ è¼‰
            if (loadMore && !hasMoreMessages[roomId]) {
                return;
            }
            
            isLoadingMessages = true;
            try {
                const cursor = messagesCursor[roomId] || '';
                const url = `${API_BASE}/messages?room_id=${roomId}&user_id=${currentUser}&limit=20&cursor=${cursor}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const newMessages = data.data || [];
                    
                    // å¾Œç«¯è¿”å›çš„æ˜¯é™åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰ï¼Œéœ€è¦åè½‰æˆå‡åºï¼ˆæœ€èˆŠåœ¨å‰ï¼‰
                    const reversedMessages = [...newMessages].reverse();
                    
                    if (loadMore) {
                        // å¾€å‰è¿½åŠ ï¼ˆèˆŠæ¶ˆæ¯åœ¨å‰ï¼‰- é€™äº›æ˜¯æ›´æ—©çš„è¨Šæ¯ï¼Œæ”¾åœ¨å‰é¢
                        messageHistory[roomId] = [...reversedMessages, ...messageHistory[roomId]];
                    } else {
                        // é¦–æ¬¡åŠ è¼‰
                        messageHistory[roomId] = reversedMessages;
                    }
                    
                    // æ›´æ–° cursor å’Œç‹€æ…‹
                    messagesCursor[roomId] = data.next_cursor || '';
                    hasMoreMessages[roomId] = data.has_more || false;
                    
                    renderMessages(roomId, loadMore);
                } else {
                    showError('è¼‰å…¥æ¶ˆæ¯å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('è¼‰å…¥æ¶ˆæ¯å¤±æ•—: ' + error.message);
            } finally {
                isLoadingMessages = false;
            }
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages(roomId, loadMore = false) {
            const messages = messageHistory[roomId] || [];
            const messagesContainer = document.getElementById('messages');
            
            // å¦‚æœæ˜¯åŠ è¼‰æ›´å¤šï¼ˆå¾€ä¸ŠåŠ è¼‰ï¼‰ï¼Œä¿å­˜ç•¶å‰æ»¾å‹•ä½ç½®
            let previousScrollHeight = 0;
            if (loadMore) {
                previousScrollHeight = messagesContainer.scrollHeight;
            }
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;">é‚„æ²’æœ‰æ¶ˆæ¯</div>';
                return;
            }
            
            // åœ¨é–‹é ­æ·»åŠ  "åŠ è¼‰æ›´å¤š" æç¤º
            let loadMoreIndicator = '';
            if (hasMoreMessages[roomId]) {
                loadMoreIndicator = `<div class="load-more-indicator" style="text-align: center; padding: 15px; color: #999; font-size: 12px;">
                    ${isLoadingMessages ? 'è¼‰å…¥ä¸­...' : 'å¾€ä¸Šæ»¾å‹•è¼‰å…¥æ›´å¤š'}
                </div>`;
            }

            messagesContainer.innerHTML = loadMoreIndicator + messages.map(msg => {
                // ç³»çµ±æ¶ˆæ¯ç‰¹æ®Šè™•ç†
                if (msg.type === 'system' || msg.sender_id === 'system') {
                    return `
                        <div class="message system">
                            <div class="message-content">
                                ${getDisplayName(msg.content.replace(' å·²åŠ å…¥ç¾¤çµ„', '').replace(' å·²é›¢é–‹ç¾¤çµ„', ''))}${msg.content.includes('å·²åŠ å…¥ç¾¤çµ„') ? ' å·²åŠ å…¥ç¾¤çµ„' : ' å·²é›¢é–‹ç¾¤çµ„'}
                            </div>
                        </div>
                    `;
                }

                // è¨ˆç®—å·²è®€ç‹€æ…‹
                const readBy = msg.read_by || [];
                
                // ç²å–èŠå¤©å®¤æˆå“¡
                const room = rooms.find(r => r.id === msg.room_id);
                
                // æ’é™¤è‡ªå·±å’Œç™¼é€è€…ï¼Œåªè¨ˆç®—å…¶ä»–äººçš„å·²è®€
                const otherReadBy = readBy.filter(userId => {
                    return userId !== currentUser && userId !== msg.sender_id;
                });
                const readCount = otherReadBy.length;
                
                // ç²å–èŠå¤©å®¤æˆå“¡æ•¸é‡ï¼ˆç”¨æ–¼ç¾¤çµ„å·²è®€è¨ˆç®—ï¼Œæ’é™¤è‡ªå·±å’Œç™¼é€è€…ï¼‰
                const otherMemberCount = (room && room.members) ? room.members.filter(member => 
                    member.user_id !== currentUser && member.user_id !== msg.sender_id
                ).length : 1;
                
                let readStatus = '';
                if (msg.sender_id === currentUser) {
                    if (readCount > 0) {
                        if (room && room.type === 'group') {
                            readStatus = `${readCount}å·²è®€`;
                        } else if (room && room.members) {
                            // ç§èŠï¼šæª¢æŸ¥å°æ–¹æ˜¯å¦å·²è®€
                            const otherMember = room.members.find(member => member.user_id !== currentUser);
                            const isReadByOther = otherMember && readBy.includes(otherMember.user_id);
                            readStatus = isReadByOther ? 'å·²è®€' : 'å·²é€é”';
                        } else {
                            readStatus = 'å·²é€é”';
                        }
                    } else {
                        readStatus = 'å·²é€é”';
                    }
                }

                return `
                    <div class="message ${msg.sender_id === currentUser ? 'own' : 'other'}">
                        <div class="message-avatar">${getDisplayName(msg.sender_id).charAt(0)}</div>
                        <div>
                            <div class="message-content">
                                ${msg.content}
                            </div>
                            <div class="message-info">
                                ${msg.sender_id === currentUser ? 
                                    `<span>${new Date(msg.created_at * 1000).toLocaleTimeString()}</span>${readStatus ? '<span class="read-status">' + readStatus + '</span>' : ''}` : 
                                    `${getDisplayName(msg.sender_id)} â€¢ ${new Date(msg.created_at * 1000).toLocaleTimeString()}`
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // æ¢å¾©æ»¾å‹•ä½ç½®ï¼ˆå¾€ä¸ŠåŠ è¼‰æ™‚ï¼‰æˆ–æ»¾å‹•åˆ°åº•éƒ¨ï¼ˆé¦–æ¬¡åŠ è¼‰ï¼‰
            if (loadMore && previousScrollHeight > 0) {
                // ä¿æŒåŸä¾†çš„ä½ç½®ï¼ˆæ¸›å»æ–°å…§å®¹çš„é«˜åº¦å·®ï¼‰
                const newScrollHeight = messagesContainer.scrollHeight;
                messagesContainer.scrollTop = newScrollHeight - previousScrollHeight;
            } else {
                // æ»¾å‹•åˆ°åº•éƒ¨
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // é€£æ¥ WebSocketï¼ˆæš«æ™‚ç¦ç”¨ï¼‰
        function connectWebSocket(roomId) {
            // é—œé–‰èˆŠçš„ SSE é€£æ¥
            if (window.eventSource) {
                window.eventSource.close();
            }
            
            // æ¸…é™¤èˆŠçš„è¼ªè©¢å®šæ™‚å™¨
            if (window.messageRefreshInterval) {
                clearInterval(window.messageRefreshInterval);
            }
            
            // ä½¿ç”¨ SSE (Server-Sent Events) é€£æ¥ gRPC Stream
            const url = `${API_BASE}/messages/stream?room_id=${roomId}&user_id=${currentUser}`;
            window.eventSource = new EventSource(url);
            
            window.eventSource.onopen = function() {
                updateStatus('å·²é€£æ¥', 'connected');
            };
            
            // ç›£è½é€£æ¥ç¢ºèªäº‹ä»¶
            window.eventSource.addEventListener('connected', function(e) {
                updateStatus('å·²é€£æ¥', 'connected');
            });
            
            // ç›£è½å¿ƒè·³äº‹ä»¶
            window.eventSource.addEventListener('ping', function(e) {
                // ä¿æŒé€£æ¥æ´»èº
            });
            
            // ç›£è½è¨Šæ¯äº‹ä»¶
            window.eventSource.addEventListener('message', function(e) {
                try {
                    const message = JSON.parse(e.data);
                    
                    // åªè™•ç†ç•¶å‰èŠå¤©å®¤çš„è¨Šæ¯
                    if (message.room_id !== roomId) {
                        return;
                    }
                    
                    // æ·»åŠ åˆ°è¨Šæ¯æ­·å²
                    if (!messageHistory[roomId]) {
                        messageHistory[roomId] = [];
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡è¤‡ï¼‰
                    const exists = messageHistory[roomId].some(m => m.id === message.id);
                    if (!exists) {
                        messageHistory[roomId].push(message);
                        renderMessages(roomId);
                        
                        // è‡ªå‹•æ¨™è¨˜ç‚ºå·²è®€
                        markRoomAsRead(roomId);
                    }
                } catch (error) {
                    console.error('è™•ç† SSE è¨Šæ¯å¤±æ•—:', error);
                }
            });
            
            // ç›£è½éŒ¯èª¤äº‹ä»¶
            window.eventSource.addEventListener('error', function(e) {
                // éœé»˜è™•ç†éŒ¯èª¤
            });
            
            window.eventSource.onerror = function(error) {
                updateStatus('é€£æ¥ä¸­æ–·', 'disconnected');
                
                // é—œé–‰èˆŠé€£æ¥
                if (window.eventSource) {
                    window.eventSource.close();
                }
                
                // 5ç§’å¾Œé‡æ–°é€£æ¥
                setTimeout(() => {
                    if (currentRoom && currentRoom.id === roomId) {
                        connectWebSocket(roomId);
                    }
                }, 5000);
            };
        }

        // è™•ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(message) {
            if (message.type === 'new_message' && message.room_id === currentRoom.id) {
                // æ·»åŠ æ–°æ¶ˆæ¯åˆ°æ­·å²è¨˜éŒ„
                if (!messageHistory[currentRoom.id]) {
                    messageHistory[currentRoom.id] = [];
                }
                messageHistory[currentRoom.id].push(message);
                
                // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
                renderMessages(currentRoom.id);
            }
        }

        // ç™¼é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentRoom) return;

            try {
                // å¦‚æœæ˜¯è‡¨æ™‚èŠå¤©å®¤ï¼ˆå°šæœªå‰µå»ºï¼‰ï¼Œå…ˆå‰µå»ºèŠå¤©å®¤
                if (currentRoom.isTemporary) {
                    const createResponse = await fetch(`${API_BASE}/rooms`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: currentRoom.name,
                            type: 'direct',
                            owner_id: currentUser,
                            members: currentRoom.members
                        })
                    });

                    const createData = await createResponse.json();
                    
                    if (!createData.success) {
                        showError('å‰µå»ºèŠå¤©å®¤å¤±æ•—: ' + createData.message);
                        return;
                    }

                    // æ›´æ–°ç•¶å‰èŠå¤©å®¤ç‚ºçœŸå¯¦èŠå¤©å®¤
                    currentRoom.id = createData.data.id;
                    currentRoom.isTemporary = false;
                    delete currentRoom.targetContactId;

                    // æ·»åŠ åˆ°èŠå¤©å®¤åˆ—è¡¨
                    rooms.push(currentRoom);
                    renderRoomList();
                }

                // ç™¼é€è¨Šæ¯
                const response = await fetch(`${API_BASE}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        room_id: currentRoom.id,
                        sender_id: currentUser,
                        content: content,
                        type: 'text'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    input.value = '';
                    // ç«‹å³åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨å’ŒèŠå¤©å®¤åˆ—è¡¨
                    await loadMessages(currentRoom.id);
                    await loadRooms();
                } else {
                    showError('ç™¼é€æ¶ˆæ¯å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('ç™¼é€æ¶ˆæ¯å¤±æ•—: ' + error.message);
            }
        }

        // å‰µå»ºèŠå¤©å®¤
        async function createRoom() {
            const name = document.getElementById('roomName').value;
            const selectedMembers = Array.from(document.getElementById('roomMembers').selectedOptions).map(option => option.value);
            
            // ç¾¤çµ„èŠå¤©éœ€è¦é¸æ“‡è‡³å°‘1å€‹æˆå“¡ï¼ˆä¸å«è‡ªå·±ï¼‰
            if (selectedMembers.length < 1) {
                showError('ç¾¤çµ„èŠå¤©éœ€è¦é¸æ“‡è‡³å°‘1å€‹å…¶ä»–æˆå“¡');
                return;
            }

            try {
                // å¾Œç«¯æœƒè‡ªå‹•åŠ å…¥å‰µå»ºè€…ï¼Œæ‰€æœ‰äººéƒ½æ˜¯ memberï¼ˆæ²’æœ‰ç®¡ç†å“¡ï¼‰
                const membersData = selectedMembers.map(memberId => ({
                    user_id: memberId,
                    role: 'member'
                }));

                const response = await fetch(`${API_BASE}/rooms`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        type: 'group',
                        owner_id: currentUser,
                        members: membersData
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('èŠå¤©å®¤å‰µå»ºæˆåŠŸ');
                    hideCreateRoomModal();
                    loadRooms();
                } else {
                    showError('å‰µå»ºèŠå¤©å®¤å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('å‰µå»ºèŠå¤©å®¤å¤±æ•—: ' + error.message);
            }
        }

        // é¡¯ç¤ºå‰µå»ºèŠå¤©å®¤æ¨¡æ…‹æ¡†
        function showCreateRoomModal() {
            document.getElementById('createRoomModal').style.display = 'block';
            document.getElementById('roomName').value = '';
            
            // æ›´æ–°æˆå“¡åˆ—è¡¨ï¼ˆéæ¿¾æ‰ç•¶å‰ç”¨æˆ¶ï¼‰
            const membersSelect = document.getElementById('roomMembers');
            membersSelect.innerHTML = contacts
                .filter(c => c.id !== currentUser)
                .map(contact => `<option value="${contact.id}">${contact.name}</option>`)
                .join('');
        }

        // éš±è—å‰µå»ºèŠå¤©å®¤æ¨¡æ…‹æ¡†
        function hideCreateRoomModal() {
            document.getElementById('createRoomModal').style.display = 'none';
        }

        // é¡¯ç¤ºç¾¤çµ„è¨­ç½®
        function showRoomSettings() {
            if (!currentRoom || currentRoom.type !== 'group') {
                showError('åªæœ‰ç¾¤çµ„èŠå¤©æ‰èƒ½é€²è¡Œè¨­ç½®');
                return;
            }

            document.getElementById('roomSettingsModal').style.display = 'block';
            renderRoomMembers();
            updateAddMemberSelect();
        }

        // éš±è—ç¾¤çµ„è¨­ç½®
        function hideRoomSettings() {
            document.getElementById('roomSettingsModal').style.display = 'none';
        }

        // æ¸²æŸ“ç¾¤çµ„æˆå“¡åˆ—è¡¨
        function renderRoomMembers() {
            const membersList = document.getElementById('roomMembersList');
            const room = rooms.find(r => r.id === currentRoom.id);
            
            if (!room || !room.members) {
                membersList.innerHTML = '<p>ç„¡æˆå“¡è³‡æ–™</p>';
                return;
            }

            membersList.innerHTML = room.members.map(member => {
                const contact = contacts.find(c => c.id === member.user_id);
                const displayName = contact ? contact.name : member.user_id;
                const isCurrentUser = member.user_id === currentUser;
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <div>
                            <span style="font-weight: 500;">${displayName}</span>
                            ${member.role === 'admin' ? '<span style="color: #007bff; margin-left: 5px; font-size: 12px;">ç®¡ç†å“¡</span>' : ''}
                            ${isCurrentUser ? '<span style="color: #666; margin-left: 5px; font-size: 12px;">(æˆ‘)</span>' : ''}
                        </div>
                        ${!isCurrentUser ? `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="removeMember('${member.user_id}')">ç§»é™¤</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°å¯æ·»åŠ æˆå“¡çš„ä¸‹æ‹‰é¸å–®
        function updateAddMemberSelect() {
            const select = document.getElementById('addMemberSelect');
            const room = rooms.find(r => r.id === currentRoom.id);
            
            if (!room || !room.members) {
                select.innerHTML = '<option value="">é¸æ“‡è¦æ·»åŠ çš„æˆå“¡</option>';
                return;
            }

            const memberIds = room.members.map(m => m.user_id);
            const availableContacts = contacts.filter(c => !memberIds.includes(c.id));

            select.innerHTML = '<option value="">é¸æ“‡è¦æ·»åŠ çš„æˆå“¡</option>' + 
                availableContacts.map(contact => 
                    `<option value="${contact.id}">${contact.name}</option>`
                ).join('');
        }

        // æ·»åŠ æˆå“¡
        async function addMember() {
            const select = document.getElementById('addMemberSelect');
            const userId = select.value;

            if (!userId) {
                showError('è«‹é¸æ“‡è¦æ·»åŠ çš„æˆå“¡');
                return;
            }

            console.log('æ·»åŠ æˆå“¡ - Room ID:', currentRoom.id, 'User ID:', userId);
            console.log('å®Œæ•´ Room å°è±¡:', currentRoom);

            try {
                const url = `${API_BASE}/rooms/${currentRoom.id}/members`;
                console.log('è«‹æ±‚ URL:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });

                const data = await response.json();
                console.log('æ·»åŠ æˆå“¡å›æ‡‰:', data);
                
                if (data.success) {
                    showSuccess('æˆå“¡æ·»åŠ æˆåŠŸ');
                    // é‡æ–°è¼‰å…¥èŠå¤©å®¤åˆ—è¡¨
                    await loadRooms();
                    // æ›´æ–°ç•¶å‰èŠå¤©å®¤å°è±¡
                    const updatedRoom = rooms.find(r => r.id === currentRoom.id);
                    if (updatedRoom) {
                        currentRoom = updatedRoom;
                    }
                    // é‡æ–°æ¸²æŸ“æˆå“¡åˆ—è¡¨
                    renderRoomMembers();
                    updateAddMemberSelect();
                    // é‡æ–°è¼‰å…¥æ¶ˆæ¯ä»¥é¡¯ç¤ºç³»çµ±æ¶ˆæ¯
                    await loadMessages(currentRoom.id);
                } else {
                    showError('æ·»åŠ æˆå“¡å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('æ·»åŠ æˆå“¡å¤±æ•—: ' + error.message);
            }
        }

        // ç§»é™¤æˆå“¡
        async function removeMember(userId) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤æˆå“¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/rooms/${currentRoom.id}/members/${userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('æˆå“¡ç§»é™¤æˆåŠŸ');
                    // é‡æ–°è¼‰å…¥èŠå¤©å®¤åˆ—è¡¨
                    await loadRooms();
                    // æ›´æ–°ç•¶å‰èŠå¤©å®¤å°è±¡
                    const updatedRoom = rooms.find(r => r.id === currentRoom.id);
                    if (updatedRoom) {
                        currentRoom = updatedRoom;
                    }
                    // é‡æ–°æ¸²æŸ“æˆå“¡åˆ—è¡¨
                    renderRoomMembers();
                    updateAddMemberSelect();
                    // é‡æ–°è¼‰å…¥æ¶ˆæ¯ä»¥é¡¯ç¤ºç³»çµ±æ¶ˆæ¯
                    await loadMessages(currentRoom.id);
                } else {
                    showError('ç§»é™¤æˆå“¡å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('ç§»é™¤æˆå“¡å¤±æ•—: ' + error.message);
            }
        }

        // é€€å‡ºç¾¤çµ„
        async function leaveRoom() {
            if (!confirm('ç¢ºå®šè¦é€€å‡ºç¾¤çµ„å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/rooms/${currentRoom.id}/members/${currentUser}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('å·²é€€å‡ºç¾¤çµ„');
                    hideRoomSettings();
                    currentRoom = null;
                    document.getElementById('chatTitle').textContent = 'é¸æ“‡èŠå¤©å®¤';
                    document.getElementById('chatType').textContent = '';
                    document.getElementById('roomSettingsBtn').style.display = 'none';
                    document.getElementById('messages').innerHTML = '<div style="text-align: center; color: #999; padding: 80px 50px; display: flex; flex-direction: column; align-items: center; gap: 20px;"><div style="font-size: 64px;">ğŸ’¬</div><div style="font-size: 18px; color: #666;">é¸æ“‡èŠå¤©å®¤é–‹å§‹å°è©±</div><div style="font-size: 14px; color: #999;">å¾å·¦å´èŠå¤©å®¤åˆ—è¡¨é¸æ“‡ï¼Œæˆ–é»æ“Šè¯çµ¡äººé–‹å§‹æ–°å°è©±</div></div>';
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendBtn').disabled = true;
                    await loadRooms();
                } else {
                    showError('é€€å‡ºç¾¤çµ„å¤±æ•—: ' + data.message);
                }
            } catch (error) {
                showError('é€€å‡ºç¾¤çµ„å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°ç‹€æ…‹
        function updateStatus(text, className) {
            const status = document.getElementById('status');
            if (status) {
                status.textContent = text;
                status.className = `status ${className}`;
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            const messages = document.getElementById('messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            messages.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const messages = document.getElementById('messages');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            messages.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const createModal = document.getElementById('createRoomModal');
            const settingsModal = document.getElementById('roomSettingsModal');
            
            if (event.target === createModal) {
                hideCreateRoomModal();
            }
            if (event.target === settingsModal) {
                hideRoomSettings();
            }
        }

        // åˆ‡æ›æˆå“¡åˆ—è¡¨é¡¯ç¤º/éš±è—
        function toggleMemberList() {
            const sidebar = document.getElementById('membersSidebar');
            if (sidebar.style.display === 'none' || !sidebar.style.display) {
                sidebar.style.display = 'flex';
                renderMembersSidebar();
            } else {
                sidebar.style.display = 'none';
            }
        }

        // æ¸²æŸ“æˆå“¡å´é‚Šæ¬„
        function renderMembersSidebar() {
            const membersList = document.getElementById('membersSidebarList');
            
            if (!currentRoom || !currentRoom.members) {
                membersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æ²’æœ‰æˆå“¡</div>';
                return;
            }

            membersList.innerHTML = currentRoom.members.map(member => {
                const displayName = getDisplayName(member.user_id);
                const roleText = member.role === 'admin' ? 'ç®¡ç†å“¡' : 'æˆå“¡';
                const isCurrentUser = member.user_id === currentUser;
                
                return `
                    <div class="member-item">
                        <div class="member-avatar">${displayName.charAt(0)}</div>
                        <div class="member-info">
                            <div class="member-name">${displayName}${isCurrentUser ? ' (æˆ‘)' : ''}</div>
                            <div class="member-role">${roleText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å…¨å±€éŒ¯èª¤æ•æ‰
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€éŒ¯èª¤:', event.error);
            console.error('éŒ¯èª¤è¨Šæ¯:', event.message);
            console.error('éŒ¯èª¤ä½ç½®:', event.filename, event.lineno, event.colno);
            // é˜²æ­¢é é¢é‡æ–°è¼‰å…¥
            event.preventDefault();
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªè™•ç†çš„ Promise éŒ¯èª¤:', event.reason);
            // é˜²æ­¢é é¢é‡æ–°è¼‰å…¥
            event.preventDefault();
        });
    </script>
</body>
</html>
